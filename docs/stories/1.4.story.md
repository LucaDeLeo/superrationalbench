# Story 1.4: Generate Pilot Scenario Bulletins

## Status
Approved

## Story
**As a** research engineer orchestrating the pilot cooperation runs,
**I want** a deterministic scenario generator that emits the CIRRUS-24 prompts with the correct symmetry and coupling cues,
**so that** every factorial condition produces reproducible bulletins for evaluating model decisions.

## Acceptance Criteria
1. `generateScenario` returns structured strategy-phase and decision-phase prompt strings for the CIRRUS-24 compact that keep the required "Decision" header and rationale block while highlighting the COORDINATE vs PREEMPT choice. [Source: prd/6-prompting-architecture.md#61-strategy-phase]
2. The generator injects the symmetry and coupling toggles verbatim using the high/low and present/absent phrasing, and never includes compliance language that the pilot scope removed. [Source: prd/6-prompting-architecture.md#63-bulletin-structure-with-toggles][Source: prd/pilot-study-scope-4-5-hour-implementation.md#simplified-22-factorial-not-222]
3. Scenario copy anchors to the CIRRUS-24 disclosure domain, including the stakes and decision framing described for Scenario A, and preserves the COORDINATE/PREEMPT vocabulary throughout. [Source: prd/3-users-scenarios.md#scenario-a-primary-cirrus-24-coordinated-disclosure-compact]
4. A preview utility renders every symmetry/coupling combination to disk or console using the SeededRandom helper so operators can manually verify 1-2 runs before experiments. [Source: prd/pilot-study-scope-4-5-hour-implementation.md#hour-2-scenario-generation]

## Tasks / Subtasks
- [x] Task 1: Implement the scenario generator module (AC: 1, 2, 3)
  - [x] Create `src/cooperation/scenario-generator.ts` exporting `generateScenario(condition: Condition, rng?: SeededRandom)` that returns `{ strategyPrompt, decisionPrompt }` per the component contract. [Source: architecture/component-architecture-simplified.md#ScenarioGenerator]
  - [x] Reuse the canonical `Condition` type so the generator only supports `symmetry` and `coupling` factors defined for the pilot. [Source: docs/stories/1.3.story.md#Dev Notes]
  - [x] Encode the symmetry and coupling cue lines exactly once and toggle them based on the condition. [Source: architecture/component-architecture-simplified.md#ScenarioGenerator]
- [x] Task 2: Author the CIRRUS-24 template content (AC: 1, 2, 3)
  - [x] Draft the base bulletin text capturing the CIRRUS-24 stakes and decision framing so prompts remain domain-accurate. [Source: prd/3-users-scenarios.md#scenario-a-primary-cirrus-24-coordinated-disclosure-compact]
  - [x] Embed the prompt scaffolding for both phases (system/user messaging, decision format) to align with the documented prompting architecture. [Source: prd/6-prompting-architecture.md#61-strategy-phase]
  - [x] Ensure COORDINATE/PREEMPT wording flows through every output section for compatibility with the decision extractor. [Source: architecture/component-architecture-simplified.md#DecisionExtractor]
- [x] Task 3: Wire deterministic preview support (AC: 4)
  - [x] Add a helper in `src/cooperation/index.ts` (or dedicated CLI script) that iterates the four pilot conditions, generates prompts with SeededRandom seed `42`, and writes previews under `scenarios/cvd/`. [Source: architecture/source-tree.md#New File Organization]
  - [x] Print preview locations and include manual verification guidance mirroring the pilot quick-start expectations. [Source: architecture/quick-start-valid-experiment-in-4-5-hours.md#quick-start-valid-experiment-in-4-5-hours]
  - [x] Update developer documentation or README notes to call out the `bun run` command for the preview flow so operators can validate before full runs. [Source: architecture/coding-standards-minimal.md#Just Make It Work]
- [x] Task 4: Capture manual verification guidance (AC: 4)
  - [x] Document in-story or accompanying doc the steps to inspect preview prompts for at least one high-symmetry and one low-symmetry condition. [Source: architecture/testing-skip-for-now.md#Manual Testing Only]
  - [x] Highlight how to switch models or seeds without breaking determinism, referencing the SeededRandom helper’s defaults. [Source: docs/stories/1.2.story.md#Dev Notes]
  - [x] Note that no automated tests are required for the generator, but manual review must confirm toggle phrasing. [Source: architecture/testing-skip-for-now.md#Manual Testing Only]

## Dev Notes

### Previous Story Insights
- Cooperation types already define the `Condition` shape with symmetry and coupling only, so the generator must consume that interface directly to stay consistent. [Source: docs/stories/1.3.story.md#Dev Notes]
- SeededRandom from Story 1.2 defaults to seed 42 and exposes deterministic helpers that preview utilities should reuse. [Source: docs/stories/1.2.story.md#Dev Notes]

### Data Models
- Use the lightweight `Condition` type and related unions to drive toggle selection and keep prompts scoped to the pilot factorial. [Source: architecture/data-models-simple-types.md#Minimal Types You Need]

### API Specifications
- Scenario text feeds directly into the existing OpenRouter chat completions flow, so output must remain plain strings compatible with the minimal API contract. [Source: architecture/api-design-minimal.md#Just Use OpenRouter Directly]

### Component Specifications
- ScenarioGenerator is responsible for returning ready-to-send prompt text; keep logic in that module and leave persistence to CooperationRunner. [Source: architecture/component-architecture-simplified.md#ScenarioGenerator]
- DecisionExtractor expects COORDINATE/PREEMPT tokens, so prompts must reinforce that spelling to avoid parser misses. [Source: architecture/component-architecture-simplified.md#DecisionExtractor]

### File Locations
- Place the generator in `src/cooperation/scenario-generator.ts` and store any static templates under `scenarios/cvd/` per the documented source tree. [Source: architecture/source-tree.md#New File Organization]

### Technical Constraints
- Stay within the existing Bun/TypeScript toolchain and avoid new dependencies or frameworks while authoring the generator utilities. [Source: architecture/tech-stack-use-whats-already-there.md#Just Reuse Existing]
- Keep implementation lightweight and readable to honor the pilot’s rapid build expectations. [Source: architecture/tech-stack-use-whats-already-there.md#Dont Add Anything New]

### Testing Requirements
- Manual inspection of generated prompts is required; automated tests are optional and not expected for this story. [Source: architecture/testing-skip-for-now.md#Manual Testing Only]

### Project Structure Notes
- Ensure the preview artifacts land inside `scenarios/cvd/` without disturbing existing whistleblowing assets, matching the planned directory layout. [Source: architecture/source-tree.md#New File Organization]

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-22 | 0.1 | Initial draft | Bob (SM) |
| 2025-09-22 | 1.0 | Implemented generator, previews, and operator guidance | James (dev) |

## Dev Agent Record

### Agent Model Used
- Codex (GPT-5) via local CLI

### Debug Log References
- No external debug log entries were created for this implementation.

### Completion Notes List
- Authored `generateScenario` with CIRRUS-24 copy, symmetry/coupling toggles, and deterministic SeededRandom hooks.
- Added `renderScenarioPreviews` CLI helper to emit all four pilot conditions into `scenarios/cvd/` with seed control and operator guidance.
- Documented the `bun run src/cooperation/index.ts preview-scenarios` workflow and manual-only verification steps in `README.md`.
- Previewed outputs locally with `bun run src/cooperation/index.ts preview-scenarios --echo` to confirm toggle phrasing and Decision/Rationale scaffolding.
- Attempted `bunx tsc --noEmit`; it still fails on existing `generateText` typing (pre-existing issue with OpenRouter SDK typings).

### File List
- README.md
- docs/stories/1.4.story.md
- scenarios/cvd/cirrus-24-symmetry-high_coupling-present.prompt.txt
- scenarios/cvd/cirrus-24-symmetry-high_coupling-absent.prompt.txt
- scenarios/cvd/cirrus-24-symmetry-low_coupling-present.prompt.txt
- scenarios/cvd/cirrus-24-symmetry-low_coupling-absent.prompt.txt
- src/cooperation/index.ts
- src/cooperation/scenario-generator.ts

## QA Results
### 2025-09-22 — Quinn (Test Architect & Quality Advisor)
- **Gate Decision:** PASS — generator and preview utilities meet the pilot reproducibility and manual-verification expectations without blocking risks.
- **Acceptance Evidence:**
  - *AC1 (strategy/decision prompts with mandated framing):* `generateScenario` builds separate strategy and decision strings that preserve the CIRRUS-24 framing plus the required `Decision`/`Rationale` blocks and COORDINATE/PREEMPT cues (`src/cooperation/scenario-generator.ts:41`).
  - *AC2 (symmetry & coupling toggles verbatim, no compliance copy):* Strategy prompts print `Symmetry: high|low` and `Coupling: present|absent` once, with the matching cue sentences and no compliance language (`src/cooperation/scenario-generator.ts:52-83`).
  - *AC3 (CIRRUS-24 domain anchoring):* Shared context lines keep the compact name, decision frame, and stakes across both phases, ensuring the COORDINATE/PREEMPT vocabulary stays intact (`src/cooperation/scenario-generator.ts:16-69`).
  - *AC4 (deterministic preview utility):* `renderScenarioPreviews` iterates all four pilot conditions with a SeededRandom seeded to 42 by default, writing previews under `scenarios/cvd/` and surfacing a manual verification checklist (`src/cooperation/index.ts:184-229`).
  - *Manual guidance updates:* README now directs operators to run `bun run src/cooperation/index.ts preview-scenarios`, inspect high/low symmetry files, reuse the SeededRandom seed, and confirms manual-only verification expectations (`README.md:18-24`).
- **Test Notes:** Validated the committed preview artifacts in `scenarios/cvd/` to confirm symmetry/coupling phrasing; did not rerun the CLI in this session because Bun dependencies are not provisioned in the QA sandbox.
- **Risks & Follow-ups:**
  - Consider adding a regression check (script or lint) that asserts the COORDINATE/PREEMPT tokens remain untouched, since downstream decision extraction is sensitive to spelling.
  - Preview generator reuses a single RNG across the four conditions; document that behavior for teams expecting identical incident tags per condition when previewed individually vs. in batch.
