# Story 1.2: Implement SeededRandom Class

## Status
Done

## Story
**As a** research engineer preparing the pilot experiment,
**I want** a deterministic `SeededRandom` utility with common helpers,
**so that** every cooperation run can be reproduced and audited.

## Acceptance Criteria
1. SeededRandom class provides deterministic random numbers
2. Supports all required methods (`nextFloat`, `nextInt`, `shuffle`, `choice`)
3. Reproducible results with same seed
4. Unit tests verify determinism

## Tasks / Subtasks
- [x] Task 1: Implement linear congruential core (AC: 1, 2, 3)
  - [x] Create `SeededRandom` class using constants from the architecture quick-start example [Source: architecture/quick-start-valid-experiment-in-4-5-hours.md#quick-start-valid-experiment-in-4-5-hours]
  - [x] Expose internal `next()` method that advances the seed and returns a float in `[0,1)` [Source: architecture/quick-start-valid-experiment-in-4-5-hours.md#quick-start-valid-experiment-in-4-5-hours]
  - [x] Initialize with default seed `42` when none supplied to align with coding standards [Source: architecture/coding-standards-minimal.md#just-make-it-work]
- [x] Task 2: Add helper methods required by AC (AC: 2, 3)
  - [x] Implement `nextFloat()` wrapper around `next()` to satisfy acceptance criteria [Source: prd/epic-1-pilot-foundation.md#story-1.2-implement-seededrandom-class]
  - [x] Implement `nextInt(maxExclusive, minInclusive = 0)` with bounds checking and deterministic output per story requirements [Source: prd/epic-1-pilot-foundation.md#story-1.2-implement-seededrandom-class]
  - [x] Implement in-place `shuffle` using SeededRandom-driven swaps to guarantee repeatable permutations [Source: prd/epic-1-pilot-foundation.md#story-1.2-implement-seededrandom-class]
  - [x] Implement `choice<T>(items: T[])` returning deterministic selection and throw on empty input [Source: prd/epic-1-pilot-foundation.md#story-1.2-implement-seededrandom-class]
- [x] Task 3: Integrate utility into cooperation module (AC: 1, 2, 3)
  - [x] Place class in `src/cooperation/seeded-random.ts` and export factory/helper to support scenario generation [Source: architecture/source-tree.md#new-file-organization]
  - [x] Update `src/cooperation/index.ts` to export `SeededRandom` for reuse across future stories [Source: architecture/source-tree.md#new-file-organization]
  - [x] Provide usage snippet in README or docstring referencing pilot experiment quick start [Source: architecture/quick-start-valid-experiment-in-4-5-hours.md#quick-start-valid-experiment-in-4-5-hours]
- [x] Task 4: Verify determinism via unit tests (AC: 4)
  - [x] Create test file `src/cooperation/__tests__/seeded-random.test.ts` covering determinism and helper correctness as demanded by the acceptance criteria [Source: prd/epic-1-pilot-foundation.md#story-1.2-implement-seededrandom-class]
  - [x] Assert same seed produces identical sequences and different seeds diverge to prove reproducibility [Source: prd/epic-1-pilot-foundation.md#story-1.2-implement-seededrandom-class]
  - [x] Document how to run the deterministic test suite so future agents can validate AC 4 quickly [Source: prd/epic-1-pilot-foundation.md#story-1.2-implement-seededrandom-class]

## Dev Notes

### Previous Story Insights
- Cooperation runner already persists verification results and enforces rate limiting, so new utilities should integrate without duplicating persistence logic. [Source: docs/stories/1.1.story.md#dev-notes]
- Existing story established `.env` expectations and dry-run support, so SeededRandom must remain side-effect free and avoid new environment configuration. [Source: docs/stories/1.1.story.md#dev-notes]

### Data Models
- Experimental `Condition` type uses `symmetry` and `coupling` factors; randomness will parameterize scenario generation across these factors. [Source: architecture/data-models-simple-types.md#minimal-types-you-need]

### API Specifications
No specific guidance found in architecture docs.

### Component Specifications
- `ScenarioGenerator` composes randomized scenario text, so SeededRandom should be implemented as a reusable dependency for that component. [Source: architecture/component-architecture-simplified.md#scenariogenerator]

### File Locations
- Place deterministic utilities within `src/cooperation` alongside other cooperation components to match the prescribed source tree. [Source: architecture/source-tree.md#new-file-organization]

### Testing Requirements
- Architecture prioritizes manual validation for the pilot, but this story’s acceptance criteria explicitly require unit tests; highlight this as a necessary exception when planning implementation. [Source: architecture/testing-skip-for-now.md#manual-testing-only]

### Technical Constraints
- Maintain minimal dependencies, reuse existing TypeScript/Bun stack, and prefer simple implementations (LCG with seed 42) to stay within the rapid pilot timeframe. [Source: architecture/tech-stack-use-whats-already-there.md#just-reuse-existing]
- Coding standards call for fixed seeds (42) to ensure reproducibility; SeededRandom should respect this default. [Source: architecture/coding-standards-minimal.md#just-make-it-work]

### Project Structure Notes
- Adding `src/cooperation/seeded-random.ts` aligns with the documented source organization and introduces no conflicts with existing files. [Source: architecture/source-tree.md#new-file-organization]
- Implementation must remain self-contained without new packages to comply with architecture constraints. [Source: architecture/tech-stack-use-whats-already-there.md#dont-add-anything-new]

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-22 | 0.1 | Initial draft | Bob (SM) |
| 2025-09-22 | 1.0 | Implemented deterministic SeededRandom utility and tests | James (dev) |

## Dev Agent Record

### Agent Model Used

- GPT-5 (Codex CLI) — James

### Debug Log References

- .ai/debug-log.md#L8

### Completion Notes List

- Added `SeededRandom` linear congruential generator with helpers (`nextFloat`, `nextInt`, `shuffle`, `choice`) using the quick-start constants and default seed 42.
- Exported the RNG factory from `src/cooperation/index.ts` and documented usage inside `seeded-random.ts` for scenario generators.
- Recorded deterministic Bun test suite validating reproducibility and helper behaviour.

### File List

- src/cooperation/seeded-random.ts
- src/cooperation/index.ts
- src/cooperation/__tests__/seeded-random.test.ts
- .ai/debug-log.md

## QA Results

### 2025-09-22 — Quinn (Test Architect & Quality Advisor)
- **Gate Decision:** PASS — deterministic RNG helpers meet all acceptance criteria with reproducible evidence and no blocking defects.
- **Acceptance Evidence:**
  - *AC1 (Deterministic random numbers):* `SeededRandom.next` applies the project LCG constants to yield stable floats and is validated by the golden-sequence test in `src/cooperation/__tests__/seeded-random.test.ts:8-23`.
  - *AC2 (Helper methods available):* `nextFloat`, `nextInt`, `shuffle`, and `choice` are implemented with bounds validation at `src/cooperation/seeded-random.ts:38-75`, and exercised through targeted unit coverage in `seeded-random.test.ts:35-78`.
  - *AC3 (Same-seed reproducibility):* Parallel instances seeded with `1337` generate identical arrays in the "produces identical sequences" spec, proving repeatability.
  - *AC4 (Determinism tests):* `bun test src/cooperation/__tests__/seeded-random.test.ts` locks the helper behaviours, including error paths for invalid bounds.
- **Test Notes:** `bun test src/cooperation/__tests__/seeded-random.test.ts` (7 tests, 72 ms) passed locally.
- **Risks & Follow-ups:**
  - Add a regression test covering non-finite/negative seeds to ensure `normalizeSeed` continues defaulting to `42` when inputs are invalid (low risk, future hardening).
- **Recommended Status:** Ready for Done
